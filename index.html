<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>Atomic updates</title>

  <meta name="viewport" content="width=device-width"/>

  <link rel="stylesheet" href="./css/reset.css" type="text/css"/>
  <link rel="stylesheet" href="./css/showoff.css" type="text/css"/>

  <link type="text/css" href="./css/fg.menu.css" media="screen" rel="stylesheet" />
  <link type="text/css" href="./css/theme/ui.all.css" media="screen" rel="stylesheet" />
  <link type="text/css" href="./css/sh_style.css" rel="stylesheet" />

  <script type="text/javascript" src="./js/jquery-1.7.2.min.js"></script>
  <script type="text/javascript" src="./js/jquery.cycle.all.js"></script>
	<script type="text/javascript" src="./js/jquery-print.js"></script>
  <script type="text/javascript" src="./js/jquery.batchImageLoad.js"></script>

  <script type="text/javascript" src="./js/jquery.doubletap-0.1.js"></script>

  <script type="text/javascript" src="./js/fg.menu.js"></script>
  <script type="text/javascript" src="./js/showoff.js"></script>
  <script type="text/javascript" src="./js/jTypeWriter.js"> </script>
  <script type="text/javascript" src="./js/sh_main.min.js"></script>
  <script type="text/javascript" src="./js/core.js"></script>
  <script type="text/javascript" src="./js/showoffcore.js"></script>
  <script type="text/javascript" src="./js/coffee-script.js"></script>

  
    
      <script type="text/javascript" src="./js/sh_lang/sh_ruby.min.js"></script>
    
      <script type="text/javascript" src="./js/sh_lang/sh_sql.min.js"></script>
    
  

  

  

  <script type="text/javascript">
  $(function(){
      setupPreso(false, './');
  });
  </script>

</head>

<body>

<a tabindex="0" href="#search-engines" class="fg-button fg-button-icon-right ui-widget ui-state-default ui-corner-all" id="navmenu"><span class="ui-icon ui-icon-triangle-1-s"></span>slides</a>
<div id="navigation" class="hidden"></div>

<div id="help">
  <table>
    <tr><td class="key">z, ?</td><td>toggle help (this)</td></tr>
    <tr><td class="key">space, &rarr;</td><td>next slide</td></tr>
    <tr><td class="key">shift-space, &larr;</td><td>previous slide</td></tr>
    <tr><td class="key">d</td><td>toggle debug mode</td></tr>
    <tr><td class="key">## &lt;ret&gt;</td><td>go to slide #</td></tr>
    <tr><td class="key">c, t</td><td>table of contents (vi)</td></tr>
    <tr><td class="key">f</td><td>toggle footer</td></tr>
    <tr><td class="key">r</td><td>reload slides</td></tr>
    <tr><td class="key">n</td><td>toggle notes</td></tr>
    <tr><td class="key">p</td><td>run preshow</td></tr>
    <tr><td class="key">P</td><td>toggle pause</td></tr>
  </table>
</div>

<div class="buttonNav">
  <input type="submit" onClick="prevStep();" value="prev"/>
  <input type="submit" onClick="nextStep();" value="next"/>
</div>

<div id="preso">loading presentation...</div>
<div id="footer">
  <span id="slideInfo"></span>
  <span id="debugInfo"></span>
  <span id="notesInfo"></span>
</div>

<div id="slides" class="offscreen" style="display:none;">
<div class="slide" data-transition="none"><div class="content" ref="one/slide/1">
<h1>Atomic operations</h1>

<p>Szymon Fiedler | @fidelski | github.com/fidel</p>
</div>
</div><div class="slide" data-transition="none"><div class="content" ref="one/slide/2">
<p><img src="./file/one/wrong.jpg" width="300" height="291" alt="You're doing it wrong!"/>

<p>probably</p>
</p>
</div>
</div><div class="slide" data-transition="none"><div class="content smaller bullets incremental" ref="one/slide/3">
<h1>Let's ensure that only 30 students can sign up for course</h1>

<pre class="sh_ruby"><code>@course = Course.find(1)
if @course.num_students &lt; 30
  @course.course_students.create!(:student_id =&gt; 101)
  @course.num_students += 1
  @course.save!
else
  # course is full
end</code></pre>

<ul>
<li>32 students in 30 person class. WTF?!</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content smaller bullets incremental" ref="one/slide/4">
<h1>Let's use ActiveRecord locking</h1>

<pre class="sh_ruby"><code>@course = Course.find(1, :lock =&gt; true)
if @course.num_students &lt; 30
  # ...</code></pre>

<ul>
<li>If you need high concurency, you're screwed</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content smaller bullets incremental" ref="one/slide/5">
<h1>Let's remove separate counter</h1>

<pre class="sh_ruby"><code>@course = Course.find(1)
if @course.course_students.count &lt; 30
  @course.course_students.create!(:student_id =&gt; 101)
else
  # course is full
end</code></pre>

<ul>
<li>Nope, it still won't work</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content bullets incremental smaller" ref="one/slide/6">
<h1>When race conidition arises?</h1>

<ul>
<li><p>when there's difference between evaluating and altering a value</p></li>
<li><p>the more lines of code between operation</p></li>
<li><p>the higher user count</p></li>
<li><p>the bigger the window of opportunity for other clients to get data in an incosistent state</p></li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content bullets incremental smaller" ref="one/slide/7">
<h1>Probably race condition, but seems legit</h1>

<pre class="sh_ruby"><code>@user = User.find(params[:id])
@post = Post.create(:user_id =&gt; @user.id,
  :title =&gt; "Whattup")
@user.total_posts += 1  # update my post count</code></pre>
</div>
</div><div class="slide" data-transition="none"><div class="content bullets incremental smaller" ref="one/slide/8">
<h1>However this would be problematic</h1>

<pre class="sh_ruby"><code>@blog = Blog.find(params[:id])
@post = Post.create(:blog_id =&gt; @blog.id,
  :title =&gt; "Whattup")
@blog.total_posts += 1  # update post count across all users    </code></pre>

<ul>
<li>As multiple users could be adding posts concurrently.</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content bullets incremental smaller" ref="one/slide/9">
<h2>You can increment counters atomically in RDBMS but not return them</h2>

<pre class="sh_sql"><code>update users set total_posts = total_posts + 1 where id = 372</code></pre>
</div>
</div><div class="slide" data-transition="none"><div class="content bullets incremental smaller" ref="one/slide/10">
<h2>You can use AR increment_counter class method</h2>

<pre class="sh_ruby"><code>@blog = Blog.find(params[:id])
Blog.increment_counter :total_posts, @blog.id
if @blog.total_posts == 1000
  # the 1000th poster - award them a gold star!</code></pre>

<ul>
<li>It solves problem a half</li>
<li>Your object is no longer in sync with the DB</li>
<li>The DB says 1000, but your @blog object still says 999, and the right person doesn&#x2019;t get their gold star.</li>
<li>Sad faces all around.</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content bullets incremental smaller" ref="one/slide/11">
<h1>But there's a better way</h1>

<ul>
<li>Any operation that can alter a value must return that value in the same operation for it to be atomic</li>
<li>There are few systems that support "increment and return"</li>
<li>Redis</li>
<li>Oracle sequences</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content bullets incremental smaller" ref="one/slide/12">
<h1>Use cases</h1>

<ul>
<li>Ensuring there are no more than 30 students in a course</li>
<li>Getting more than 2 but less than 6 people in a game</li>
<li>Keeping a chat room to a max of 50 people</li>
<li>Correctly recording the total number of blog posts</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content bullets incremental smaller" ref="one/slide/13">
<h1>Best way</h1>

<ul>
<li>A counter you base logic on (eg, slots_taken)</li>
<li><p>A counter users see (eg, current_students)</p></li>
<li><p>Why?</p></li>
<li><p>You increment logic counter first before checking it to address race condition</p></li>
<li><p>But that's not a problem</p></li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content smaller" ref="one/slide/14">
<h1>Course example</h1>

<pre class="sh_ruby"><code>class Course &lt; ActiveRecord::Base
  include Redis::Objects

  counter :slots_taken
  counter :current_students
end</code></pre>
</div>
</div><div class="slide" data-transition="none"><div class="content smaller bullets incremental" ref="one/slide/15">
<pre class="sh_ruby"><code>@course = Course.find(1)
@course.slots_taken.increment do |val|
  if val &lt;= @course.max_students
    @course.course_students.create!(:student_id =&gt; 101)
    @course.current_students.increment
  end
end</code></pre>

<ul>
<li>Race condition free</li>
<li>Because we're checking direct result of the increment operation against a value</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content smaller bullets" ref="one/slide/16">
<h1>Source</h1>

<ul>
<li>http://nateware.com/2010/02/18/an-atomic-rant/</li>
</ul>
</div>
</div><div class="slide" data-transition="none"><div class="content smaller" ref="one/slide/17">
<h1>Thanks!</h1>
</div>
</div></div>
<div id="pauseScreen">
  
</div>

</body>
</html>
